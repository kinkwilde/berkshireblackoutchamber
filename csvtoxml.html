<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CSV to XML Converter</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .container {
        max-width: 600px;
        margin: 0 auto;
        text-align: center;
      }
      input[type='file'] {
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>CSV to XML Converter</h1>
      <input type="file" id="csvFile" accept=".csv" />
      <br />
      <button onclick="convertToXML()">Convert and Download XML</button>
      <p id="status"></p>
    </div>

    <script>
      function convertToXML() {
        const fileInput = document.getElementById('csvFile');
        const status = document.getElementById('status');

        if (!fileInput.files.length) {
          status.textContent = 'Please select a CSV file to upload.';
          return;
        }

        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = function (event) {
          const csvContent = event.target.result;
          const lines = csvContent.split('\n').filter((line) => line.trim());

          if (lines.length < 2) {
            status.textContent =
              'The CSV file must have at least one data row.';
            return;
          }

          const headers = lines[0]
            .split(',')
            .map((header) => header.replace(/"/g, '').trim());
          const rows = lines.slice(1);

          // Generate XML structure
          let xml = `<?xml version="1.0" encoding="UTF-8"?>\n<types>\n`;

          rows.forEach((row) => {
            const values = row
              .split(',')
              .map((value) => value.replace(/"/g, '').trim());
            xml += `  <type name="${values[headers.indexOf('name')]}" >\n`;

            headers.forEach((header) => {
              if (header === 'name') return;

              if (
                header === 'tags' ||
                header === 'usages' ||
                header === 'values'
              ) {
                const items = values[headers.indexOf(header)]
                  .split(';')
                  .filter((item) => item);
                const tagName = header.slice(0, -1); // singular form (tag, usage, value)
                items.forEach((item) => {
                  xml += `    <${tagName} name="${item}" />\n`;
                });
              } else {
                xml += `    <${header}>${values[headers.indexOf(header)]}</${header}>\n`;
              }
            });

            xml += `  </type>\n`;
          });

          xml += `</types>`;

          // Create XML file
          const blob = new Blob([xml], {
            type: 'application/xml;charset=utf-8;',
          });
          const url = URL.createObjectURL(blob);

          // Trigger download
          const link = document.createElement('a');
          link.setAttribute('href', url);
          link.setAttribute('download', 'converted.xml');
          link.style.display = 'none';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);

          status.textContent = 'XML file created successfully!';
        };

        reader.onerror = function () {
          status.textContent = 'Error reading the file.';
        };

        reader.readAsText(file);
      }
    </script>
  </body>
</html>
